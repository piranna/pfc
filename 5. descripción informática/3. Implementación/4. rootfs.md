### rootfs

La tercera capa contenia originalmente los archivos correspondientes al inicio
del sistema y los archivos comunes a todos los usuarios, actuando como sistema
de archivos raiz real tal y como sucede en un sistema operativo estandar. Sin
embargo, al estar NodeOS ahora basado en `initramfs` y al uso de *OverlayFS*
para proporcionar un sistema de archivos raiz único para cada usuario, la
funcionalidad que proporciona se reduce solamente a hospedar el kernel de Linux
y la imagen con el disco [initramfs](3. initramfs.html), actuando como partición
de arranque. No obstante, debido al estado tan inicial en el que se encuentra el
desarrollo, se ha decidido mantener el nombre en previsión de que esta situación
pueda cambiar en el futuro, aunque por el diseño que se le ha aplicado a la
arquitectura de NodeOS esto es poco probable.

Este cambio de funcionalidad se hizo principalmente para facilitar la
compatibilidad con plataformas donde el sistema de arranque requiere del uso de
una particion [VFAT](http://mnrf.galeon.com/i/so2/vfat.htm) como es el
micro-ordenador [Raspberry Pi](https://www.raspberrypi.org) y otras placas de
bajo coste como [BeagleBoard](http://beagleboard.org) y similares, ya que
*OverlayFS* no es compatible con dicho sistema de archivos, dando un error al
intentar usarlo[^1]. Por este motivo, debido a los pocos componentes que
realmente estaban siendo compartidos por todos los usuarios, decidi hacer que
todos ellos tuvieran su propia copia como es el caso del archivo
`/etc/resolv.conf` para definir el servidor DNS, y de este modo no solo otorgaba
a los usuarios mas flexibilidad para configurar el sistema a sus necesidades
sino ademas tambien abria la posibilidad a que la partición *rootfs* pudiera ser
de solo-lectura y por tanto el poder generar facilmente una version Live CD del
sistema. Esto tiene ademas la ventaja adicional de que las estructuras internas
y el enfoque dado por el sistema de archivos `ISO9660` usado en los CDs de datos
son similares al de los sistemas de archivos VFAT, por lo que conceptualmente se
puede considerar que en si mismo es un VFAT de solo-lectura, lo que con este
enfoque simplifica tambien su comprensión y administración al hacerlo mas
homogeneo entre distintas plataformas.

#### Generación del sistema raiz

Segun la plataforma para la que se quiera generar el sistema, el método de
construccion del sistema raiz es distinto, siendo incluso inexistente en el caso
de generar el sistema para ser ejecutado en QEmu puesto que tanto el kernel como
initramfs son cargados directamente por él.

En caso de generar una imagen de partición (para despues generar con ella una
imagen de disco) se utiliza [genfatfs](https://github.com/xobs/genfatfs), el
cual es una adaptacion del comando *genext2fs* para generar imagenes con formato
`VFAT`. Dicha imagen contiene solamente el kernel de Linux y la imagen de
*initramfs*, a los que se les cambia el nombre para que puedan ser usados por el
gestor de arranque de *Raspberry Pi* con su configuración por defecto. En el
caso de *Raspberry Pi*, se añadiran ademas los archivos correspondientes al
[gestor de arranque y el firmware del subsistema gráfico](http://elinux.org/RPi_Advanced_Setup#Setting_up_the_boot_partition),
necesarios para que este funcione correctamente.

Por otro lado, para generar una imagen ISO el proceso es basicamente el mismo,
en este caso añadiendo los archivos correspondientes al gestor de arranque
[isolinux](http://www.syslinux.org/wiki/index.php/ISOLINUX) y generando una
imagen ISO hybrida capaz de ser usada tanto en CDs y DVDs como en pendrives y
discos duros combinando los comandos *genisoimage* e *isohybrid*. Anteriormente
generaba dicha imagen usando el comando *grub-mkrescue*, el cual permite generar
un disco de arranque personalizado basado en el gestor de arranque
[GRUB](https://www.gnu.org/software/grub), pero debido a la complejidad de su
configuración e instalación en imagenes de disco debido a que esta orientado a
ser usado sobre discos duros reales y por tanto a que requiere permisos de
administrador, decidi sustituirlo por `syslinux`/`isolinux` el cual no solo esta
diseñado especificamente para trabajar con imagenes de particiones sino que su
configuracion es mucho mas sencilla y similar a la usada por el gestor de
arranque de *Raspberry Pi* (un archivo de texto plano cuyo contenido lo lee y
parsea el gestor de arranque durante el inicio del sistema, en vez de tener que
ejecutar un comando que actualice sus estructuras internas como sucede con el
uso del comando *update-grub*).

Tambien se ha pretendido añadir soporte de arranque mediante EFI de forma que
la imagen ISO pudiera ser usada tambien en ordenadores Apple, pero esto último
no ha sido posible debido a que `isolinux` no tiene soporte para arrancar en
equipos basados en EFI y tampoco fui capaz de hacerlo arrancar mediante GRUB a
pesar de que las ISOs de otros sistemas operativos si funcionan con él o
permiten arrancar activando la emulacion de BIOS mediante el modo *Legacy-OS*.
Este hecho unido a la necesidad de una particion de lectura-escritura para poder
disfrutar plenamente del sistema me ha hecho plantearme sobre la posiblidad de
deprecar en el futuro el uso de imagenes ISO hibridas y generar unicamente
imagenes de disco enfocadas a ser grabadas en un pendrive USB.


[^1]: Intuyo que el motivo exacto esta relaccionado con la falta de soporte de permisos POSIX en los sistemas de archivos VFAT, aunque por otro lado, considero que tecnicamente no habria ningun impedimento para poder ser usado como una de las capas subyacente de solo-lectura permitiendo el acceso a todos sus archivos por defecto, lo cual es justo mi caso de uso.
