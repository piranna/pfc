### rootfs

La tercera capa del sistema corresponde al sistema de archivos raiz.
Originalmente contenia los archivos correspondientes al arranque del sistema y
los archivos comunes a todos los usuarios como sucede en un sistema operativo
estandar, pero al estar ahora esta basado en initramfs y al uso de OverlayFS
para proporcionar un sistema de archivos raiz unico para cada usuario, ahora la
funcionalidad de este se reduce solamente a hospedar el kernel de Linux y la
imagen con el disco initramfs durante el arranque, siendo su funcionalidad mas
próxima al de una particion `/boot` en un sistema operativo tradicional que a la
de un sistema de archivos raiz real[^1].

Este cambio de funcionalidad se debio principalmente para facilitar la
compatibilidad con plataformas donde el sistema de arranque requiere del uso de
una particion VFAT como es el micro-ordenador Raspberry Pi y otras muchas placas
de bajo coste como BleagleBoard y similares, ya que OverlayFS no es compatible
con dicho sistema de archivos (intuyo que el motivo exacto esta relaccionado con
el soporte de permisos POSIX completo, aunque por otro lado, considero que
tecnicamente no habria ningun impedimento para poder ser usado como una de las
capas subyacente de solo-lectura, el cual era justo mi caso de uso). Por este
motivo, decidi mover los pocos componentes que estaban siendo compartidos por
todos los usuarios de forma que todos ellos tuvieran su propia copia como es el
caso del archivo ```/etc/resolv.conf```, y de este modo no solo otorgaba a los
usuarios mas flexibilidad para configurar el sistema a sus necesidades sino
ademas tambien abria la posibilidad a que la particion *rootfs* fuera de
solo-lectura y por tanto el poder hacer facilmente una version Live CD. Esto
tiene ademas la ventaja adicional de que las estructuras internas y el enfoque
dado por el sistema de archivos ISO9660 usado en los CDs de datos son similares
al de los sistemas de archivos FAT, por lo que conceptualmente se puede
considerar que en si mismo es un FAT de solo-lectura, haciendo el sistema mas
homogeneo entre plataformas y simplificando no solo su generacion sino tambien
facilitando su comprensión y administración.

#### Generación del sistema raiz

Segun la plataforma para la que se quiera generar el sistema, el metodo de
construccion del sistema raiz es distinto, siendo incluso inexistente en el caso
de generar el sistema para ser ejecutado en QEmu puesto que tanto el kernel como
initramfs son cargados directamente por el.

En caso de generar una imagen de particion (para despues generar con ella una
imagen de disco) se utiliza [genfatfs](), el cual es una adaptacion del comando
*genext2fs* para generar imagenes de particion con formato VFAT. Dicha imagen
contendra solamente el kernel de Linux y el initramfs, a los que se les cambia
el nombre para que puedan ser usados por el gestor de arranque de Raspberry Pi
con su configuración por defecto. En el caso de Raspberry Pi, se añadiran ademas
los archivos
[correspondientes al gestor de arranque y del firmware del subsistema grafico](http://elinux.org/RPi_Advanced_Setup#Setting_up_the_boot_partition),
necesarios para que este funcione correctamente.

Por otro lado, para generar una imagen ISO el proceso es basicamente el mismo,
en este caso añadiendo los archivos correspondientes al gestor de arranque
[isolinux](http://www.syslinux.org/wiki/index.php/ISOLINUX) y generando una
imagen ISO hybrida capaz de ser usada tanto en CDs y DVDs como en pendrives y
discos duros combinando los compandos *genisoimage* e *isohybrid*. Anteriormente
generaba dicha imagen usando el comando *grub-mkrescue*, el cual permite
generar un disco de arranque personalizado basado en el gestor de arranque GRUB,
pero debido a lo complejo de su configuracion e instalacion en imagenes de disco
debido a que esta orientado a ser usado sobre discos duros reales con permisos
de administrador, decidi sustituirlo por syslinux/isolinux el cual esta diseñado
especificamente para trabajar con imagenes de particiones y ademas su
configuracion es mucho mas sencilla y similar a la usada por el gestor de
arranque de Raspberry Pi (un archivo de texto plano editable incluso desde otros
sistemas cuyo contenido lo lee y parsea el gestor de arranque durante el inicio
del sistema en vez de tener que ejecutar un comando que actualice sus
estructuras internas como sucede con el comando *update-grub*).

Tambien se ha pretendido añadir soporte de arranque mediante EFI de forma que
la imagen ISO pudiera ser usada tambien ordenadores Apple, pero esto ultimo no
ha sido posible debido a que isolinux no tiene soporte para arrancar en equipos
basados en EFI y tampoco fui capaz de hacerlo arrancar mediante distintas
pruebas con GRUB a pesar de que las ISOs de otros sistemas operativos si
funcionan arrancar o activando la emulacion de BIOS mediante el modo *Legacy-OS*.
Esto unido a la necesidad de una particion de lectura-escritura para poder
disfrutar plenamente del sistema me ha hecho plantearme sobre la posiblidad de
deprecar en el futuro el uso de imagenes ISO hibridas y generar unicamente
imagenes de disco enfocadas a ser grabadas en un pendrive USB.

[^1]: No obstante, debido al estado tan inicial del desarrollo se ha decidido
      mantener el nombre en prevision de que esta situacion cambie.
