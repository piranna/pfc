### barebones

La primera capa del sistema consiste solamente en un kernel Linux que ejecuta un
interprete REPL de Node.js, siendo esta la version mas minima del sistema.

El ejecutable de Node.js es compilado desactivando las opciones de depuración
para reducir su tamaño ya que estara permanentemente en memoria, y la cache de
modulos ya que es posible que se este haciendo una compilación para una
plataforma distinta y por lo tanto la cache seria invalida, por lo que de esta
forma aceleramos el tiempo de compilación al ahorrarnos este paso. Igualmente
tampoco se instala el gestor de paquetes npm por defecto, dejando que el
usuario lo instale en su directorio de usuario mas adelante si lo necesitara.

La version de Node.js utilizada es la v0.11.14, la cual se ha parcheado para que
la version de OpenSSL que incorpora pueda linkearse con la libreria musl
empleada por el cross-compiler en vez de glibc, y a la que tambien se le ha
incluido la version de NodeOS para la que se esta compilando como una cadena de
texto de forma que pueda saberse en tiempo de ejecución. Se ha decidio usar esta
version ya que versiones posteriores utilizan una version del motor Javascript
v8 incompatible y de la que han sido reportados problemas por parte de varias
personas. No obstante, se espera que a corto plazo esto quede resuelto y pueda
usarse una version estable de Node.js, la cual ademas tambien utilizaria una
version mas actualizada de OpenSSL que no necesita ser parcheada para funcionar
correctamente con musl.

La version de Linux utilizada es la 4.1 ya que se hace uso del soporte de
multiples capas de solo lectura en el sistema de archivos OverlayFS, el cual se
incluyo en el codigo fuente upstream en la version 3.20-rc1 (despues renombrada
a 4.0-rc1) y usado como base para la creación de sistemas de archivos raiz
independientes para cada uno de los usuarios.

La configuración del kernel se basa en la configuración por defecto para la
plataforma concreta para la que se este generando el sistema, en la que despues
se deshabilita el soporte de modulos (de forma que todo quede compilado dentro
del propio binario del kernel, simplificando despues la administración del
sistema) y tambien las herramientas de depuración y algunos componentes
obsoletos o superfluos activados por defecto como sistemas de archivos no
habituales actualmente para reducir el tamaño del kernel, y al que se ha
habilitado el soporte para FUSE y el OverlayFS antes citado.

En la configuración del kernel tambien se ha habilitado el soporte de initramfs
de forma que se pueda incluir el ejecutable de Node.js y sus librerias asociadas
dentro del propio kernel. Para poder crear el initramfs sin requerir permisos de
administrador (necesarios para configurar el usuario y los permisos de acceso de
los archivos incluidos en el) se ha decidido usar un archivo de configuracin.
Sin embargo, al no poderse usar rutas fijas a los archivos a incluir ya que
estas dependen de la plataforma y CPU para el que se esta compilando el sistema,
se ha decidido incluir dichos valores como variables bash dentro del archivo de
configuración y procesarlo mediante el comando ```echo``` de forma que funcione
como un sistema de plantillas y genere el archivo de configuración que se va a
usar finalmente con sus rutas correctas:

```bash
eval "echo \"$(< cpio.txt)\"" > $OBJ_DIR/cpio.txt
```

Docker utiliza su propio kernel de Linux (en concreto, el kernel que se este
usando en el sistema host), por lo que solo es necesario generar la capa base
del sistema. Para poder usar el mismo archivo de configuración usado para
incorporar el ejecutable de Node.js y sus librerias dentro del kernel de Linux,
primero se genera la utilidad ```gen_init_cpio``` usada internamente por el
proceso de compilación del kernel la cual crea un archivo comprimido en formato
cpio y despues se convierte dicho archivo al formato tar requerido por Docker.

Por ultimo, se comprueba el correcto funcionamiento del modulo. Para ello, se
ejecuta dentro de una maquina virtual QEmu redireccionando la entrada y salida
estandar de forma que pueda ser procesada, y mediante el modulo [suppose]() (el
cual en un sistema interactivo devuelve una respuesta ante la recepción de un
determinado texto, y al que añadi soporte de ejecución de funciones como
respuesta) se espera a recibir el prompt REPL de Node.js corriendo dentro de
NodeOS en un tiempo prudencial (actualmente 15 segundos) antes de emitir un
fallo, y despues se le envian fragmentos de codigo Javascript para comprobar que
los procesa y responde correctamente a ellos.
